<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Presen칞a Semin치rio Pilangu치</title>

<style>
body{
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
  margin:0;
}

.container{
  background:white;
  padding:30px;
  border-radius:12px;
  box-shadow:0 8px 20px rgba(0,0,0,0.08);
  width:320px;
  text-align:center;
}

h1{
  font-size:20px;
  margin-bottom:20px;
  color:#333;
}

input{
  width:100%;
  padding:12px;
  border:1px solid #ddd;
  border-radius:8px;
  font-size:16px;
  margin-bottom:15px;
}

button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:8px;
  font-size:16px;
  background:#2c7be5;
  color:white;
  cursor:pointer;
}

button:hover{
  background:#1a68d1;
}

#msg{
  margin-top:15px;
  font-size:14px;
  color:#444;
}
</style>

</head>

<body>

<div class="container">
  <h1>Presen칞a<br>Semin치rio Pilangu치</h1>

  <input type="text" id="nome" placeholder="Digite seu nome">
  <button onclick="enviar()">Registrar Presen칞a</button>

  <p id="msg"></p>
</div>

<script>

function getDeviceId() {
  let id = localStorage.getItem("deviceId");
  if (!id) {
    id = crypto.randomUUID();
    localStorage.setItem("deviceId", id);
  }
  return id;
}

// 游늸 Coordenadas corretas
const LAT_LOCAL = -25.38226224646342;
const LNG_LOCAL = -49.294483646886995;

// 游댠 Raio ajustado
const RAIO = 200;

function distancia(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const 픥1 = lat1*Math.PI/180;
  const 픥2 = lat2*Math.PI/180;
  const 풊픥 = (lat2-lat1)*Math.PI/180;
  const 풊풭 = (lon2-lon1)*Math.PI/180;

  const a =
    Math.sin(풊픥/2)*Math.sin(풊픥/2) +
    Math.cos(픥1)*Math.cos(픥2) *
    Math.sin(풊풭/2)*Math.sin(풊풭/2);

  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  return R*c;
}

function enviar() {

  let nome = document.getElementById("nome").value.trim();
  let deviceId = getDeviceId();

  if(!nome){
    alert("Digite seu nome");
    return;
  }

  document.getElementById("msg").innerText = "Verificando localiza칞칚o...";

  navigator.geolocation.getCurrentPosition(
    function(pos){

      let dist = distancia(
        pos.coords.latitude,
        pos.coords.longitude,
        LAT_LOCAL,
        LNG_LOCAL
      );

      if(dist > RAIO){
        document.getElementById("msg").innerText =
          "Fora do local (" + Math.round(dist) + "m)";
        return;
      }

      document.getElementById("msg").innerText = "Registrando presen칞a...";

      fetch("https://script.google.com/macros/s/AKfycbw-ORd7HBuLdiz70srR4ELnkBR_SP9WWcAh1bQoK7MEQSmvVcf9qMJZdh4JOCfXTUQReQ/exec", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: "nome=" + encodeURIComponent(nome) +
              "&deviceId=" + encodeURIComponent(deviceId)
      })
      .then(res => res.text())
      .then(res => {

        if(res === "JA_RESPONDEU"){
          document.getElementById("msg").innerText =
            "Voc칡 j치 registrou presen칞a hoje.";
        } else if(res === "OK"){
          document.getElementById("msg").innerText =
            "Presen칞a registrada com sucesso!";
        } else {
          document.getElementById("msg").innerText =
            "Erro inesperado: " + res;
        }

      })
      .catch(err => {
        document.getElementById("msg").innerText =
          "Erro ao enviar: " + err;
      });

    },
    function(err){
      document.getElementById("msg").innerText =
        "Erro localiza칞칚o: " + err.message;
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    }
  );

}

</script>

</body>
</html>
