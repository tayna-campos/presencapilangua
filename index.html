<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Teste Presen√ßa</title>

<style>
body{
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
  margin:0;
}

.container{
  background:white;
  padding:30px;
  border-radius:12px;
  box-shadow:0 8px 20px rgba(0,0,0,0.08);
  width:320px;
  text-align:center;
}

input{
  width:100%;
  padding:12px;
  margin-bottom:15px;
}

button{
  width:100%;
  padding:12px;
  background:#2c7be5;
  color:white;
  border:none;
}

#msg{
  margin-top:15px;
}
</style>

</head>

<body>

<div class="container">
  <h2>Teste de Presen√ßa</h2>

  <input type="text" id="nome" placeholder="Digite seu nome">
  <button onclick="enviar()">Registrar</button>

  <p id="msg"></p>
</div>

<script>

function getDeviceId() {
  let id = localStorage.getItem("deviceId");
  if (!id) {
    id = crypto.randomUUID();
    localStorage.setItem("deviceId", id);
  }
  return id;
}

// üìç NOVO ENDERE√áO (TESTE)
const LAT_LOCAL = -25.3806;
const LNG_LOCAL = -49.2957;

// üî• RAIO MAIOR PARA TESTE
const RAIO = 300;

function distancia(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const œÜ1 = lat1*Math.PI/180;
  const œÜ2 = lat2*Math.PI/180;
  const ŒîœÜ = (lat2-lat1)*Math.PI/180;
  const ŒîŒª = (lon2-lon1)*Math.PI/180;

  const a =
    Math.sin(ŒîœÜ/2)**2 +
    Math.cos(œÜ1)*Math.cos(œÜ2) *
    Math.sin(ŒîŒª/2)**2;

  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

function enviar() {

  let nome = document.getElementById("nome").value.trim();
  let deviceId = getDeviceId();

  if(!nome){
    alert("Digite seu nome");
    return;
  }

  document.getElementById("msg").innerText = "Verificando localiza√ß√£o...";

  navigator.geolocation.getCurrentPosition(
    function(pos){

      let dist = distancia(
        pos.coords.latitude,
        pos.coords.longitude,
        LAT_LOCAL,
        LNG_LOCAL
      );

      if(dist > RAIO){
        document.getElementById("msg").innerText =
          "Fora do local (" + Math.round(dist) + "m)";
        return;
      }

      document.getElementById("msg").innerText =
        "Dentro do raio (" + Math.round(dist) + "m) ‚Äî enviando...";

      fetch("https://script.google.com/macros/s/AKfycbw-ORd7HBuLdiz70srR4ELnkBR_SP9WWcAh1bQoK7MEQSmvVcf9qMJZdh4JOCfXTUQReQ/exec", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: "nome=" + encodeURIComponent(nome) +
              "&deviceId=" + encodeURIComponent(deviceId)
      })
      .then(res => res.text())
      .then(res => {
        document.getElementById("msg").innerText =
          "Resposta: " + res;
      });

    },
    function(err){
      document.getElementById("msg").innerText =
        "Erro: " + err.message;
    },
    {
      enableHighAccuracy: true
    }
  );

}

</script>

</body>
</html>
